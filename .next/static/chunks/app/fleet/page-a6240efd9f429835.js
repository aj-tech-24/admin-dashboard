(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[330],{4109:function(e,s,r){Promise.resolve().then(r.bind(r,7401))},7401:function(e,s,r){"use strict";r.r(s),r.d(s,{default:function(){return F}});var t=r(7437),n=r(1480),i=r(4816),l=r(729),a=r(5630),c=r(1029),o=r(9569),d=r(7689),u=r(8556),h=r(8569),x=r(3650),v=r(3288),p=r(8256),b=r(8421),j=r(7733),g=r(5381),y=r(8357),m=r(6e3),f=r(9874),Z=r(8816),_=r(5325),T=r(6463),k=r(2265),A=r(8643),P=r(1370),C=r(8661);let{Title:S,Text:w}=o.default,{Option:B}=d.default;function F(){let{user:e,loading:s,isAdmin:r}=(0,C.a)(),o=(0,T.useRouter)(),[F,I]=(0,k.useState)([]),[N,D]=(0,k.useState)([]),[E,O]=(0,k.useState)(!0),[U,z]=(0,k.useState)(!1),[M,R]=(0,k.useState)(null),[q]=u.Z.useForm();(0,k.useEffect)(()=>{s||e?s||!e||r||(h.ZP.error("Access denied. Admin privileges required."),o.push("/")):o.push("/login")},[e,s,r,o]),(0,k.useEffect)(()=>(e&&r&&(V(),J()),()=>{P.sn.unsubscribe("buses")}),[e,r]);let V=async()=>{try{O(!0);let[e,s]=await Promise.all([(0,A.gf)(),(0,A.jT)()]);if(e.error)throw e.error;if(s.error)throw s.error;let r=(e.data||[]).map(e=>({...e,routes:Array.isArray(e.routes)?e.routes[0]:e.routes,driver:Array.isArray(e.driver)?e.driver[0]:e.driver,conductor:Array.isArray(e.conductor)?e.conductor[0]:e.conductor}));I(r),D(s.data||[])}catch(e){console.error("Error loading fleet data:",e),h.ZP.error("Failed to load fleet data")}finally{O(!1)}},J=()=>{P.sn.subscribeToBuses({onBusUpdate:e=>{V()}})},K=async(e,s)=>{try{let{error:r}=await (0,A.dc)(e,s);if(r)throw r;h.ZP.success("Bus status updated to ".concat(s)),V()}catch(e){console.error("Error updating bus status:",e),h.ZP.error("Failed to update bus status")}},L=async e=>{if(M)try{let{error:s}=await (0,A.O2)(M.id,e.driverId);if(s)throw s;h.ZP.success("Driver assigned successfully"),z(!1),R(null),q.resetFields(),V()}catch(e){console.error("Error assigning driver:",e),h.ZP.error("Failed to assign driver")}},Q=e=>{R(e),q.setFieldsValue({driverId:e.driver_id}),z(!0)},G=e=>{let s={active:{color:"green",text:"Active"},inactive:{color:"red",text:"Inactive"}}[e];return(0,t.jsx)(x.Z,{color:s.color,children:s.text})},H=[{title:"Plate Number",dataIndex:"plate_number",key:"plate_number",render:e=>(0,t.jsx)(w,{strong:!0,style:{color:"#1890ff"},children:e})},{title:"Route",key:"route",render:e=>{var s,r,n;return(0,t.jsxs)("div",{children:[(0,t.jsx)(w,{strong:!0,children:null===(s=e.routes)||void 0===s?void 0:s.name}),(0,t.jsx)("br",{}),(0,t.jsxs)(w,{type:"secondary",style:{fontSize:"12px"},children:[null===(r=e.routes)||void 0===r?void 0:r.start_address," → ",null===(n=e.routes)||void 0===n?void 0:n.end_address]})]})}},{title:"Driver",key:"driver",render:e=>e.driver?(0,t.jsxs)("div",{children:[(0,t.jsx)(w,{children:e.driver.fullName}),(0,t.jsx)("br",{}),(0,t.jsx)(w,{type:"secondary",style:{fontSize:"12px"},children:e.driver.contact_number})]}):(0,t.jsx)(w,{type:"secondary",children:"No driver assigned"})},{title:"Capacity",key:"capacity",render:e=>(0,t.jsxs)("div",{children:[(0,t.jsxs)(w,{children:[e.passengers,"/",e.capacity]}),(0,t.jsx)("br",{}),(0,t.jsxs)(w,{type:"secondary",style:{fontSize:"12px"},children:[Math.round(e.passengers/e.capacity*100),"% full"]})]})},{title:"Status",dataIndex:"status",key:"status",render:e=>G(e)},{title:"Actions",key:"actions",render:e=>(0,t.jsxs)(v.Z,{children:[(0,t.jsx)(p.ZP,{type:"link",icon:(0,t.jsx)(n.Z,{}),onClick:()=>Q(e),children:"Assign Driver"}),(0,t.jsx)(p.ZP,{type:"link",danger:"active"===e.status,onClick:()=>K(e.id,"active"===e.status?"inactive":"active"),children:"active"===e.status?"Deactivate":"Activate"})]})}],W=F.filter(e=>"active"===e.status).length,X=F.reduce((e,s)=>e+s.capacity,0),Y=F.reduce((e,s)=>e+s.passengers,0),$=F.filter(e=>e.driver_id).length;return s||E?(0,t.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:(0,t.jsx)(b.Z,{size:"large"})}):(0,t.jsxs)("div",{className:"admin-layout",children:[(0,t.jsxs)("div",{className:"admin-header",children:[(0,t.jsx)("div",{className:"admin-logo",children:"Miniway Admin Dashboard"}),(0,t.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:[(0,t.jsx)(p.ZP,{onClick:()=>o.push("/"),children:"Dashboard"}),(0,t.jsx)(p.ZP,{onClick:V,icon:(0,t.jsx)(i.Z,{}),children:"Refresh"})]})]}),(0,t.jsxs)("div",{className:"admin-content",children:[(0,t.jsx)(j.Z,{gutter:[16,16],style:{marginBottom:"24px"},children:(0,t.jsxs)(g.Z,{span:24,children:[(0,t.jsx)(S,{level:2,children:"Fleet Management"}),(0,t.jsx)(w,{type:"secondary",children:"Manage your bus fleet, assign drivers, and monitor capacity"})]})}),(0,t.jsxs)(j.Z,{gutter:[16,16],style:{marginBottom:"24px"},children:[(0,t.jsx)(g.Z,{xs:24,sm:12,md:6,children:(0,t.jsx)(y.Z,{children:(0,t.jsx)(m.Z,{title:"Active Buses",value:W,prefix:(0,t.jsx)(l.Z,{style:{color:"#52c41a"}}),valueStyle:{color:"#52c41a"}})})}),(0,t.jsx)(g.Z,{xs:24,sm:12,md:6,children:(0,t.jsx)(y.Z,{children:(0,t.jsx)(m.Z,{title:"Total Capacity",value:X,prefix:(0,t.jsx)(a.Z,{style:{color:"#1890ff"}}),valueStyle:{color:"#1890ff"}})})}),(0,t.jsx)(g.Z,{xs:24,sm:12,md:6,children:(0,t.jsx)(y.Z,{children:(0,t.jsx)(m.Z,{title:"Current Passengers",value:Y,prefix:(0,t.jsx)(a.Z,{style:{color:"#722ed1"}}),valueStyle:{color:"#722ed1"}})})}),(0,t.jsx)(g.Z,{xs:24,sm:12,md:6,children:(0,t.jsx)(y.Z,{children:(0,t.jsx)(m.Z,{title:"Buses with Drivers",value:$,prefix:(0,t.jsx)(c.Z,{style:{color:"#13c2c2"}}),valueStyle:{color:"#13c2c2"}})})})]}),(0,t.jsx)(y.Z,{title:"Bus Fleet",extra:(0,t.jsx)(v.Z,{children:(0,t.jsx)(p.ZP,{icon:(0,t.jsx)(i.Z,{}),onClick:V,children:"Refresh"})}),children:(0,t.jsx)(f.Z,{columns:H,dataSource:F,rowKey:"id",pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,s)=>"".concat(s[0],"-").concat(s[1]," of ").concat(e," buses")},scroll:{x:800}})}),(0,t.jsx)(Z.Z,{title:"Assign Driver",open:U,onCancel:()=>{z(!1),R(null),q.resetFields()},footer:null,children:(0,t.jsxs)(u.Z,{form:q,layout:"vertical",onFinish:L,children:[(0,t.jsx)(u.Z.Item,{label:"Bus",name:"bus",initialValue:null==M?void 0:M.plate_number,children:(0,t.jsx)(_.default,{disabled:!0})}),(0,t.jsx)(u.Z.Item,{label:"Driver",name:"driverId",rules:[{required:!0,message:"Please select a driver!"}],children:(0,t.jsx)(d.default,{placeholder:"Select a driver",children:N.map(e=>(0,t.jsx)(B,{value:e.id,children:(0,t.jsxs)("div",{children:[(0,t.jsx)(w,{strong:!0,children:e.fullName}),(0,t.jsx)("br",{}),(0,t.jsxs)(w,{type:"secondary",style:{fontSize:"12px"},children:[e.contact_number," • License:"," ",e.license_number]})]})},e.id))})}),(0,t.jsx)(u.Z.Item,{children:(0,t.jsxs)(v.Z,{children:[(0,t.jsx)(p.ZP,{type:"primary",htmlType:"submit",children:"Assign Driver"}),(0,t.jsx)(p.ZP,{onClick:()=>{z(!1),R(null),q.resetFields()},children:"Cancel"})]})})]})})]})]})}},1370:function(e,s,r){"use strict";r.d(s,{sn:function(){return i}});var t=r(6881);class n{subscribeToTrips(e){let s=t.O.channel("trips-changes").on("postgres_changes",{event:"*",schema:"public",table:"trips"},s=>{var r;console.log("Trip change received:",s),null===(r=e.onTripUpdate)||void 0===r||r.call(e,s)}).subscribe();return this.channels.set("trips",s),s}subscribeToBuses(e){let s=t.O.channel("buses-changes").on("postgres_changes",{event:"*",schema:"public",table:"buses"},s=>{var r;console.log("Bus change received:",s),null===(r=e.onBusUpdate)||void 0===r||r.call(e,s)}).subscribe();return this.channels.set("buses",s),s}subscribeToUsers(e){let s=t.O.channel("users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},s=>{var r;console.log("User change received:",s),null===(r=e.onUserUpdate)||void 0===r||r.call(e,s)}).subscribe();return this.channels.set("users",s),s}subscribeToTripPassengers(e){let s=t.O.channel("trip-passengers-changes").on("postgres_changes",{event:"*",schema:"public",table:"trip_passengers"},s=>{var r;console.log("Trip passenger change received:",s),null===(r=e.onTripUpdate)||void 0===r||r.call(e,s)}).subscribe();return this.channels.set("trip_passengers",s),s}subscribeToAll(e){this.subscribeToTrips(e),this.subscribeToBuses(e),this.subscribeToUsers(e),this.subscribeToTripPassengers(e)}unsubscribe(e){let s=this.channels.get(e);s&&(t.O.removeChannel(s),this.channels.delete(e))}unsubscribeAll(){this.channels.forEach((e,s)=>{t.O.removeChannel(e)}),this.channels.clear()}getChannelStatus(e){let s=this.channels.get(e);return s?s.state:"not_subscribed"}getActiveChannels(){return Array.from(this.channels.keys())}constructor(){this.channels=new Map}}let i=new n}},function(e){e.O(0,[377,943,866,403,556,689,898,882,971,23,744],function(){return e(e.s=4109)}),_N_E=e.O()}]);