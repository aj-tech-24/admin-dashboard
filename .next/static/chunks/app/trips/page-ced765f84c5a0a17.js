(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[633],{9803:function(e,s,t){Promise.resolve().then(t.bind(t,3201))},3201:function(e,s,t){"use strict";t.r(s),t.d(s,{default:function(){return D}});var r=t(7437),n=t(3098),i=t(4816),l=t(3561),a=t(729),c=t(1029),o=t(2438),d=t(9569),u=t(8556),h=t(8569),p=t(3650),x=t(3288),g=t(8256),b=t(8421),y=t(7733),m=t(5381),j=t(8357),f=t(6e3),v=t(7149),Z=t(9874),T=t(8816),k=t(5325),_=t(6463),w=t(2265),S=t(8643),C=t(1370),A=t(8661);let{Title:P,Text:I}=d.default;function D(){let{user:e,loading:s,isAdmin:t}=(0,A.a)(),d=(0,_.useRouter)(),[D,z]=(0,w.useState)([]),[E,N]=(0,w.useState)([]),[O,F]=(0,w.useState)(!0),[U,B]=(0,w.useState)(!1),[M,K]=(0,w.useState)(null),[Q]=u.Z.useForm();(0,w.useEffect)(()=>{s||e?s||!e||t||(h.ZP.error("Access denied. Admin privileges required."),d.push("/")):d.push("/login")},[e,s,t,d]),(0,w.useEffect)(()=>(e&&t&&(R(),q()),()=>{C.sn.unsubscribe("trips")}),[e,t]);let R=async()=>{try{F(!0);let[e,s]=await Promise.all([(0,S.cQ)(),(0,S.Fv)()]);if(e.error)throw e.error;if(s.error)throw s.error;let t=(e.data||[]).map(e=>({...e,buses:Array.isArray(e.buses)?e.buses[0]:e.buses,driver:Array.isArray(e.driver)?e.driver[0]:e.driver})),r=(s.data||[]).map(e=>({...e,buses:Array.isArray(e.buses)?e.buses[0]:e.buses,driver:Array.isArray(e.driver)?e.driver[0]:e.driver}));z(t),N(r)}catch(e){console.error("Error loading trips data:",e),h.ZP.error("Failed to load trips data")}finally{F(!1)}},q=()=>{C.sn.subscribeToTrips({onTripUpdate:e=>{R()}})},J=async(e,s,t)=>{try{let{error:t}=await (0,S.tM)(e,s);if(t)throw t;h.ZP.success("Trip status updated to ".concat(s)),R()}catch(e){console.error("Error updating trip status:",e),h.ZP.error("Failed to update trip status")}},W=async e=>{if(M)try{let{error:e}=await (0,S.tM)(M.id,"cancelled");if(e)throw e;h.ZP.success("Trip cancelled successfully"),B(!1),K(null),Q.resetFields(),R()}catch(e){console.error("Error cancelling trip:",e),h.ZP.error("Failed to cancel trip")}},H=e=>{K(e),B(!0)},L=e=>{let s={waiting:{color:"blue",text:"Waiting"},ongoing:{color:"green",text:"Ongoing"},completed:{color:"success",text:"Completed"},cancelled:{color:"red",text:"Cancelled"}}[e];return(0,r.jsx)(p.Z,{color:s.color,children:s.text})},V=e=>e?new Date(e).toLocaleString():"N/A",G=[{title:"Trip ID",dataIndex:"id",key:"id",render:e=>(0,r.jsxs)(I,{code:!0,style:{fontSize:"12px"},children:[e.slice(0,8),"..."]})},{title:"Bus",key:"bus",render:e=>(0,r.jsxs)("div",{children:[(0,r.jsx)(I,{strong:!0,children:e.buses.plate_number}),(0,r.jsx)("br",{}),(0,r.jsx)(I,{type:"secondary",style:{fontSize:"12px"},children:e.buses.routes.name})]})},{title:"Driver",key:"driver",render:e=>(0,r.jsxs)("div",{children:[(0,r.jsx)(I,{children:e.driver.fullName}),(0,r.jsx)("br",{}),(0,r.jsx)(I,{type:"secondary",style:{fontSize:"12px"},children:e.driver.contact_number})]})},{title:"Passengers",key:"passengers",render:e=>{let s=e.trip_passengers.filter(e=>"boarded"===e.status).length;return(0,r.jsxs)("div",{children:[(0,r.jsxs)(I,{children:[s,"/",e.buses.capacity]}),(0,r.jsx)("br",{}),(0,r.jsxs)(I,{type:"secondary",style:{fontSize:"12px"},children:[Math.round(s/e.buses.capacity*100),"% full"]})]})}},{title:"Started At",dataIndex:"started_at",key:"started_at",render:e=>V(e)},{title:"Status",dataIndex:"status",key:"status",render:e=>L(e)},{title:"Actions",key:"actions",render:e=>(0,r.jsxs)(x.Z,{children:[(0,r.jsx)(g.ZP,{type:"link",icon:(0,r.jsx)(n.Z,{}),onClick:()=>{h.ZP.info("Trip details feature coming soon")},children:"Details"}),"ongoing"===e.status&&(0,r.jsx)(g.ZP,{type:"link",onClick:()=>J(e.id,"completed"),children:"Complete"}),"completed"!==e.status&&"cancelled"!==e.status&&(0,r.jsx)(g.ZP,{type:"link",danger:!0,onClick:()=>H(e),children:"Cancel"})]})}],X=[{title:"Trip ID",dataIndex:"id",key:"id",render:e=>(0,r.jsxs)(I,{code:!0,style:{fontSize:"12px"},children:[e.slice(0,8),"..."]})},{title:"Bus",key:"bus",render:e=>(0,r.jsxs)("div",{children:[(0,r.jsx)(I,{strong:!0,children:e.buses.plate_number}),(0,r.jsx)("br",{}),(0,r.jsx)(I,{type:"secondary",style:{fontSize:"12px"},children:e.buses.routes.name})]})},{title:"Driver",key:"driver",render:e=>(0,r.jsx)(I,{children:e.driver.fullName})},{title:"Started At",dataIndex:"started_at",key:"started_at",render:e=>V(e)},{title:"Ended At",dataIndex:"ended_at",key:"ended_at",render:e=>V(e)},{title:"Duration",key:"duration",render:e=>{if(!e.started_at||!e.ended_at)return"N/A";let s=new Date(e.started_at),t=Math.round((new Date(e.ended_at).getTime()-s.getTime())/6e4);return"".concat(t," min")}},{title:"Status",dataIndex:"status",key:"status",render:e=>L(e)}],Y=D.filter(e=>"waiting"===e.status).length,$=D.filter(e=>"ongoing"===e.status).length,ee=E.filter(e=>"completed"===e.status).length,es=E.filter(e=>"cancelled"===e.status).length;return s||O?(0,r.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:(0,r.jsx)(b.Z,{size:"large"})}):(0,r.jsxs)("div",{className:"admin-layout",children:[(0,r.jsxs)("div",{className:"admin-header",children:[(0,r.jsx)("div",{className:"admin-logo",children:"Miniway Admin Dashboard"}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:"16px"},children:[(0,r.jsx)(g.ZP,{onClick:()=>d.push("/"),children:"Dashboard"}),(0,r.jsx)(g.ZP,{onClick:R,icon:(0,r.jsx)(i.Z,{}),children:"Refresh"})]})]}),(0,r.jsxs)("div",{className:"admin-content",children:[(0,r.jsx)(y.Z,{gutter:[16,16],style:{marginBottom:"24px"},children:(0,r.jsxs)(m.Z,{span:24,children:[(0,r.jsx)(P,{level:2,children:"Trip Management"}),(0,r.jsx)(I,{type:"secondary",children:"Monitor active trips and view trip history"})]})}),(0,r.jsxs)(y.Z,{gutter:[16,16],style:{marginBottom:"24px"},children:[(0,r.jsx)(m.Z,{xs:24,sm:12,md:6,children:(0,r.jsx)(j.Z,{children:(0,r.jsx)(f.Z,{title:"Waiting Trips",value:Y,prefix:(0,r.jsx)(l.Z,{style:{color:"#1890ff"}}),valueStyle:{color:"#1890ff"}})})}),(0,r.jsx)(m.Z,{xs:24,sm:12,md:6,children:(0,r.jsx)(j.Z,{children:(0,r.jsx)(f.Z,{title:"Ongoing Trips",value:$,prefix:(0,r.jsx)(a.Z,{style:{color:"#52c41a"}}),valueStyle:{color:"#52c41a"}})})}),(0,r.jsx)(m.Z,{xs:24,sm:12,md:6,children:(0,r.jsx)(j.Z,{children:(0,r.jsx)(f.Z,{title:"Completed Trips",value:ee,prefix:(0,r.jsx)(c.Z,{style:{color:"#13c2c2"}}),valueStyle:{color:"#13c2c2"}})})}),(0,r.jsx)(m.Z,{xs:24,sm:12,md:6,children:(0,r.jsx)(j.Z,{children:(0,r.jsx)(f.Z,{title:"Cancelled Trips",value:es,prefix:(0,r.jsx)(o.Z,{style:{color:"#ff4d4f"}}),valueStyle:{color:"#ff4d4f"}})})})]}),(0,r.jsx)(j.Z,{children:(0,r.jsx)(v.Z,{defaultActiveKey:"active",items:[{key:"active",label:"Active Trips (".concat(D.length,")"),children:(0,r.jsx)(Z.Z,{columns:G,dataSource:D,rowKey:"id",pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,s)=>"".concat(s[0],"-").concat(s[1]," of ").concat(e," trips")},scroll:{x:1e3}})},{key:"history",label:"History (".concat(E.length,")"),children:(0,r.jsx)(Z.Z,{columns:X,dataSource:E,rowKey:"id",pagination:{pageSize:10,showSizeChanger:!0,showQuickJumper:!0,showTotal:(e,s)=>"".concat(s[0],"-").concat(s[1]," of ").concat(e," trips")},scroll:{x:1e3}})}]})}),(0,r.jsx)(T.Z,{title:"Cancel Trip",open:U,onCancel:()=>{B(!1),K(null),Q.resetFields()},footer:null,children:(0,r.jsxs)(u.Z,{form:Q,layout:"vertical",onFinish:W,children:[(0,r.jsx)(u.Z.Item,{label:"Trip Details",name:"trip",initialValue:M?"".concat(M.buses.plate_number," - ").concat(M.buses.routes.name):"",children:(0,r.jsx)(k.default,{disabled:!0})}),(0,r.jsx)(u.Z.Item,{label:"Cancellation Reason",name:"reason",rules:[{required:!0,message:"Please provide a reason for cancellation!"}],children:(0,r.jsx)(k.default.TextArea,{rows:4,placeholder:"Enter the reason for cancelling this trip..."})}),(0,r.jsx)(u.Z.Item,{children:(0,r.jsxs)(x.Z,{children:[(0,r.jsx)(g.ZP,{type:"primary",htmlType:"submit",danger:!0,children:"Cancel Trip"}),(0,r.jsx)(g.ZP,{onClick:()=>{B(!1),K(null),Q.resetFields()},children:"Keep Trip"})]})})]})})]})]})}},1370:function(e,s,t){"use strict";t.d(s,{sn:function(){return i}});var r=t(6881);class n{subscribeToTrips(e){let s=r.O.channel("trips-changes").on("postgres_changes",{event:"*",schema:"public",table:"trips"},s=>{var t;console.log("Trip change received:",s),null===(t=e.onTripUpdate)||void 0===t||t.call(e,s)}).subscribe();return this.channels.set("trips",s),s}subscribeToBuses(e){let s=r.O.channel("buses-changes").on("postgres_changes",{event:"*",schema:"public",table:"buses"},s=>{var t;console.log("Bus change received:",s),null===(t=e.onBusUpdate)||void 0===t||t.call(e,s)}).subscribe();return this.channels.set("buses",s),s}subscribeToUsers(e){let s=r.O.channel("users-changes").on("postgres_changes",{event:"*",schema:"public",table:"users"},s=>{var t;console.log("User change received:",s),null===(t=e.onUserUpdate)||void 0===t||t.call(e,s)}).subscribe();return this.channels.set("users",s),s}subscribeToTripPassengers(e){let s=r.O.channel("trip-passengers-changes").on("postgres_changes",{event:"*",schema:"public",table:"trip_passengers"},s=>{var t;console.log("Trip passenger change received:",s),null===(t=e.onTripUpdate)||void 0===t||t.call(e,s)}).subscribe();return this.channels.set("trip_passengers",s),s}subscribeToAll(e){this.subscribeToTrips(e),this.subscribeToBuses(e),this.subscribeToUsers(e),this.subscribeToTripPassengers(e)}unsubscribe(e){let s=this.channels.get(e);s&&(r.O.removeChannel(s),this.channels.delete(e))}unsubscribeAll(){this.channels.forEach((e,s)=>{r.O.removeChannel(e)}),this.channels.clear()}getChannelStatus(e){let s=this.channels.get(e);return s?s.state:"not_subscribed"}getActiveChannels(){return Array.from(this.channels.keys())}constructor(){this.channels=new Map}}let i=new n}},function(e){e.O(0,[377,943,866,403,556,689,914,882,971,23,744],function(){return e(e.s=9803)}),_N_E=e.O()}]);