"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[882],{8661:function(e,t,n){n.d(t,{AuthProvider:function(){return i},a:function(){return u}});var r=n(7437),a=n(2265),s=n(6881);let o=(0,a.createContext)(void 0);function i(e){let{children:t}=e,[n,i]=(0,a.useState)(null),[u,d]=(0,a.useState)(!0),[l,c]=(0,a.useState)(!1),[m,f]=(0,a.useState)(!1);(0,a.useEffect)(()=>{let e=!0,t=!1;(async()=>{if(!t)try{let{data:{session:n},error:r}=await s.O.auth.getSession();if(r||!(null==n?void 0:n.user)){console.log("No valid session found, user needs to sign in"),e&&(i(null),c(!1),d(!1),f(!0),t=!0);return}(null==n?void 0:n.user)&&e&&(i(n.user),await _(n.user.id),d(!1),f(!0),t=!0)}catch(n){console.error("Error initializing auth:",n),e&&(i(null),c(!1),d(!1),f(!0),t=!0)}})();let{data:{subscription:r}}=s.O.auth.onAuthStateChange(async(t,n)=>{var r,a;console.log("Auth state changed:",t,null==n?void 0:null===(r=n.user)||void 0===r?void 0:r.id),e&&(i(null!==(a=null==n?void 0:n.user)&&void 0!==a?a:null),(null==n?void 0:n.user)?await _(n.user.id):c(!1),d(!1))}),a=()=>{s.O.auth.signOut({scope:"local"})},o=()=>{if(t&&n)return},u=()=>{if("visible"===document.visibilityState&&t&&n)return};return window.addEventListener("beforeunload",a),window.addEventListener("focus",o),document.addEventListener("visibilitychange",u),()=>{e=!1,r.unsubscribe(),window.removeEventListener("beforeunload",a),window.removeEventListener("focus",o),document.removeEventListener("visibilitychange",u)}},[]);let _=async e=>{try{let{data:o,error:i}=await s.O.from("users").select("role").eq("id",e).single();if(i){console.log("Custom users table not found or error:",i.message);let{data:{user:e}}=await s.O.auth.getUser();if(e){var t,n,r,a;let s=(null===(t=e.user_metadata)||void 0===t?void 0:t.role)==="admin"||(null===(n=e.user_metadata)||void 0===n?void 0:n.is_admin)===!0||(null===(r=e.email)||void 0===r?void 0:r.includes("admin"))||(null===(a=e.email)||void 0===a?void 0:a.includes("miniway"));c(!!s),console.log("Admin status from metadata:",s)}else c(!1);return}c((null==o?void 0:o.role)==="admin")}catch(e){console.error("Error checking admin status:",e),c(!0)}},v=async()=>{try{let{data:e,error:t}=await s.O.auth.refreshSession();if(t)throw console.error("Error refreshing session:",t),t;return e}catch(e){throw console.error("Error refreshing session:",e),e}},g=async(e,t)=>{try{d(!0);let{data:n,error:r}=await s.O.auth.signInWithPassword({email:e,password:t});if(r)throw console.error("Sign in error:",r),r;n.user&&await _(n.user.id)}finally{d(!1)}},w=async()=>{try{d(!0);let{error:e}=await s.O.auth.signOut({scope:"global"});e&&console.error("Sign out error:",e),i(null),c(!1),f(!1),localStorage.clear(),sessionStorage.clear()}finally{d(!1)}};return(0,r.jsx)(o.Provider,{value:{user:n,loading:u||!m,signIn:g,signOut:w,isAdmin:l,refreshSession:v},children:t})}function u(){let e=(0,a.useContext)(o);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},8643:function(e,t,n){n.d(t,{AW:function(){return d},Eq:function(){return l},Fv:function(){return u},O2:function(){return h},TN:function(){return a},_c:function(){return c},cQ:function(){return i},dc:function(){return p},fq:function(){return f},gf:function(){return s},jT:function(){return o},oh:function(){return g},ot:function(){return m},pz:function(){return v},qW:function(){return _},tM:function(){return O},vO:function(){return w}});var r=n(6881);let a=async()=>{let[{count:e},{count:t},{count:n},{count:a},{count:s},{count:o},{count:i}]=await Promise.all([r.O.from("buses").select("*",{count:"exact",head:!0}).eq("status","active"),r.O.from("trips").select("*",{count:"exact",head:!0}).eq("status","ongoing"),r.O.from("routes").select("*",{count:"exact",head:!0}),r.O.from("users").select("*",{count:"exact",head:!0}),r.O.from("trips").select("*",{count:"exact",head:!0}).gte("started_at",new Date().toISOString().split("T")[0]),r.O.from("trips").select("*",{count:"exact",head:!0}).eq("status","completed"),r.O.from("trips").select("*",{count:"exact",head:!0}).eq("status","cancelled")]),{data:u}=await r.O.from("trip_passengers").select("*",{count:"exact",head:!0}).eq("status","boarded");return{activeBuses:e||0,ongoingTrips:t||0,totalRoutes:n||0,totalPassengers:(null==u?void 0:u.length)||0,todayTrips:s||0,totalUsers:a||0,completedTrips:o||0,cancelledTrips:i||0}},s=async()=>{let{data:e,error:t}=await r.O.from("buses").select("\n      id,\n      plate_number,\n      capacity,\n      passengers,\n      status,\n      route_id,\n      driver_id,\n      conductor_id,\n      routes (\n        id,\n        name,\n        start_address,\n        end_address\n      ),\n      driver:users!fk_driver (\n        id,\n        fullName,\n        contact_number,\n        license_number,\n        license_expiry\n      ),\n      conductor:users!buses_conductor_id_fkey (\n        id,\n        fullName,\n        contact_number\n      )\n    ").order("plate_number");return{data:e,error:t}},o=async()=>{let{data:e,error:t}=await r.O.from("users").select("*").eq("role","driver").order("fullName");return{data:e,error:t}},i=async()=>{let{data:e,error:t}=await r.O.from("trips").select("\n      id,\n      status,\n      current_location,\n      started_at,\n      buses (\n        id,\n        plate_number,\n        capacity,\n        routes (\n          id,\n          name,\n          start_address,\n          end_address\n        )\n      ),\n      driver:users!trips_driver_id_fkey (\n        id,\n        fullName,\n        contact_number\n      ),\n      trip_passengers (\n        id,\n        status,\n        boarded_at,\n        commuter:users (\n          id,\n          fullName\n        )\n      )\n    ").in("status",["waiting","ongoing"]).order("started_at",{ascending:!1});return{data:e,error:t}},u=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,{data:t,error:n}=await r.O.from("trips").select("\n      id,\n      status,\n      started_at,\n      ended_at,\n      cancelled_at,\n      cancellation_reason,\n      buses (\n        id,\n        plate_number,\n        routes (\n          id,\n          name\n        )\n      ),\n      driver:users!trips_driver_id_fkey (\n        id,\n        fullName\n      ),\n      trip_passengers (\n        id,\n        status\n      )\n    ").in("status",["completed","cancelled"]).order("started_at",{ascending:!1}).limit(e);return{data:t,error:n}},d=async()=>{try{let{data:e,error:t}=await r.O.from("users").select("*").order("updated_at",{ascending:!1});if(t)return console.log("Users table query failed:",t.message),{data:[],error:null};return{data:e,error:t}}catch(e){return console.error("Error in getAllUsers:",e),{data:[],error:null}}},l=async e=>{try{let{data:t,error:n}=await r.O.from("users").select("*").eq("role",e).order("fullName");if(n)return console.log("Users table query failed for role:",e,n.message),{data:[],error:null};return{data:t,error:n}}catch(e){return console.error("Error in getUsersByRole:",e),{data:[],error:null}}},c=async()=>{let{data:e,error:t}=await r.O.from("routes").select("*").order("created_at",{ascending:!1});return{data:e,error:t}},m=async e=>{let{data:t,error:n}=await r.O.from("routes").insert({...e,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}).select();return{data:t,error:n}},f=async(e,t)=>{let{data:n,error:a}=await r.O.from("routes").update({...t,updated_at:new Date().toISOString()}).eq("id",e).select();return{data:n,error:a}},_=async e=>{let{data:t,error:n}=await r.O.from("routes").delete().eq("id",e);return{data:t,error:n}},v=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:30,{data:t,error:n}=await r.O.from("trips").select("\n      id,\n      status,\n      started_at,\n      ended_at,\n      buses (\n        routes (\n          name\n        )\n      )\n    ").gte("started_at",new Date(Date.now()-864e5*e).toISOString()).order("started_at",{ascending:!1});return{data:t,error:n}},g=async()=>{let{data:e,error:t}=await r.O.from("routes").select("\n      id,\n      name,\n      start_address,\n      end_address,\n      buses (\n        id,\n        plate_number,\n        status,\n        trips (\n          id,\n          status,\n          started_at\n        )\n      )\n    ");return{data:e,error:t}},w=async function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:100,{data:t,error:n}=await r.O.from("travel_history_commuter").select("\n      id,\n      start_location_name,\n      end_location_name,\n      travel_date,\n      route_name,\n      status,\n      user:users (\n        id,\n        fullName\n      )\n    ").order("travel_date",{ascending:!1}).limit(e);if(t&&!n)return{data:t,error:null};if(n&&"PGRST200"===n.code){let{data:t,error:n}=await r.O.from("trips").select("\n        id,\n        status,\n        started_at,\n        ended_at,\n        buses (\n          routes (\n            name,\n            start_address,\n            end_address\n          )\n        ),\n        driver:users!trips_driver_id_fkey (\n          id,\n          fullName\n        )\n      ").in("status",["completed","cancelled"]).order("started_at",{ascending:!1}).limit(e);return n?{data:null,error:n}:{data:(null==t?void 0:t.map(e=>{var t,n,r,a,s,o,i;return{id:e.id,start_location_name:(null===(n=e.buses)||void 0===n?void 0:null===(t=n.routes)||void 0===t?void 0:t.start_address)||"Unknown",end_location_name:(null===(a=e.buses)||void 0===a?void 0:null===(r=a.routes)||void 0===r?void 0:r.end_address)||"Unknown",travel_date:(null===(s=e.started_at)||void 0===s?void 0:s.split("T")[0])||new Date().toISOString().split("T")[0],route_name:(null===(i=e.buses)||void 0===i?void 0:null===(o=i.routes)||void 0===o?void 0:o.name)||"Unknown Route",status:e.status,created_at:e.started_at,user:e.driver}}))||[],error:null}}return{data:t,error:n}},p=async(e,t)=>{let{data:n,error:a}=await r.O.from("buses").update({status:t,updated_at:new Date().toISOString()}).eq("id",e).select();return{data:n,error:a}},h=async(e,t)=>{let{data:n,error:a}=await r.O.from("buses").update({driver_id:t,updated_at:new Date().toISOString()}).eq("id",e).select();return{data:n,error:a}},O=async(e,t,n)=>{let a={status:t,updated_at:new Date().toISOString()};n&&(a.current_location=n),"completed"===t?a.ended_at=new Date().toISOString():"cancelled"===t&&(a.cancelled_at=new Date().toISOString());let{data:s,error:o}=await r.O.from("trips").update(a).eq("id",e).select();return{data:s,error:o}}},6881:function(e,t,n){n.d(t,{O:function(){return r}});let r=(0,n(9709).eI)("https://nbbtnqdvizaxajvaijbv.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iYnRucWR2aXpheGFqdmFpamJ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0Njk3MjYsImV4cCI6MjA2ODA0NTcyNn0.nTNvDYvZgSErdEEX4GZ36BmGIsbHnMEqQZ40gKub6IU",{auth:{storage:{getItem:e=>window.localStorage.getItem(e),setItem:(e,t)=>{window.localStorage.setItem(e,t)},removeItem:e=>{window.localStorage.removeItem(e)}},autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1,flowType:"pkce"}})}}]);